# Keep ipv6.0ms.app static tester site
ipv6.0ms.app {
    encode zstd gzip
    log {
        output stdout
        format console
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
    }

    root * /srv
    file_server
    templates
}

# HTTP for CLI (no redirect) → returns IP directly
http://0ms.app {
    encode zstd gzip
    log {
        output stdout
        format console
    }
    reverse_proxy /json 127.0.0.1:8080 {
        header_up X-Forwarded-For {remote_host}
        header_up X-Real-IP {remote_host}
        header_up CF-Connecting-IP {remote_host}
    }
    reverse_proxy 127.0.0.1:8080 {
        header_up X-Forwarded-For {remote_host}
        header_up X-Real-IP {remote_host}
        header_up CF-Connecting-IP {remote_host}
    }
}

# HTTPS for 0ms.app → browsers redirect to tester; curl hits API
0ms.app {
    encode zstd gzip
    log {
        output stdout
        format console
    }

    @browser header_regexp browser User-Agent .*Mozilla.*
    redir @browser https://ipv6.0ms.app

    reverse_proxy /json 127.0.0.1:8080 {
        header_up X-Real-IP {remote}
        header_up CF-Connecting-IP {remote}
        header_up X-Forwarded-For {remote_host}
    }
    reverse_proxy 127.0.0.1:8080 {
        header_up X-Real-IP {remote}
        header_up CF-Connecting-IP {remote}
        header_up X-Forwarded-For {remote_host}
    }
}

# Subdomains used by the tester for active checks
ipv6.ipv6.0ms.app {
    encode zstd gzip
    log {
        output stdout
        format console
    }
    # Allow cross-origin requests from the main site
    header Access-Control-Allow-Origin "https://ipv6.0ms.app"
    @ping path /ping.png
    root @ping /srv
    header @ping Cache-Control "public, max-age=60"
    file_server @ping
    respond / 204
}

ipv4.ipv6.0ms.app {
    encode zstd gzip
    log {
        output stdout
        format console
    }
    # Allow cross-origin requests from the main site
    header Access-Control-Allow-Origin "https://ipv6.0ms.app"
    @ping path /ping.png
    root @ping /srv
    header @ping Cache-Control "public, max-age=60"
    file_server @ping
    respond / 204
}
