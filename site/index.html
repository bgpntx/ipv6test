<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IPv6 Connectivity Test – ipv6.0ms.app</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Spinnaker font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spinnaker&display=swap" rel="stylesheet">

  <style>
    :root {
      --ok-bg: #d1f7d6;
      --ok-fg: #0a6b1a;
      --fail-bg: #ffd4d4;
      --fail-fg: #7f0e0e;
      --muted: #555;
      --chip-radius: 999px;
    }
    html, body { height: 100%; }
    body {
      font-family: "Spinnaker", -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 2rem;
      line-height: 1.5;
      text-align: center;
    }
    .pill { display: inline-block; padding: .2rem .6rem; border-radius: var(--chip-radius); font-weight: 600; }
    .ok   { background: var(--ok-bg); color: var(--ok-fg); }
    .fail { background: var(--fail-bg); color: var(--fail-fg); }
    .info { color: var(--muted); }
    .grid {
      display: grid;
      gap: .75rem;
      max-width: 42rem;
      justify-items: center;
      text-align: center;
    }
    code  { background: #f4f4f4; padding: .15rem .35rem; border-radius: 4px; }
    footer { margin-top: 2rem; font-size: 0.9rem; color: var(--muted); }
  </style>
</head>
<body>
  <h1>IPv6 Connectivity Test</h1>

  <!-- Server-side: determine best client IP from headers, fallback to .RemoteIP -->
  {{- $cf  := .Req.Header.Get "CF-Connecting-IP" -}}
  {{- $xff := .Req.Header.Get "X-Forwarded-For" -}}
  {{- $xri := .Req.Header.Get "X-Real-IP" -}}
  {{- $ip  := "" -}}
  {{- if $cf -}}
    {{- $ip = $cf -}}
  {{- else if $xff -}}
    {{- $ip = (trim (index (splitList "," $xff) 0)) -}}
  {{- else if $xri -}}
    {{- $ip = $xri -}}
  {{- else -}}
    {{- $ip = .RemoteIP -}}
  {{- end -}}

  <p>
    You reached this page over:
    {{ if gt (len (splitList ":" $ip)) 1 -}}
      <span class="pill ok">IPv6</span>
    {{- else -}}
      <span class="pill fail">IPv4</span>
    {{- end }}
    <span class="info">(<code>{{ $ip }}</code>)</span>
  </p>

  <!-- Client-side: active dual-stack connectivity test using IPv4-only & IPv6-only hostnames -->
  <div class="grid">
    <div>
      <strong>Active test (client-side):</strong>
      <div>IPv6-only hostname: <code>https://ipv6.ipv6.0ms.app/ping.png</code> → <span id="v6" class="pill">testing…</span></div>
      <div>IPv4-only hostname: <code>https://ipv4.ipv6.0ms.app/ping.png</code> → <span id="v4" class="pill">testing…</span></div>
      <div class="info">The test loads a tiny image from each subdomain. Success means your connection can actually reach that stack.</div>
    </div>
  </div>

  <script>
    // Load an image with timeout; report OK/FAIL based on onload/onerror.
    function testImage(url, elId, timeoutMs = 4000) {
      const el = document.getElementById(elId);
      const img = new Image();
      const t = setTimeout(() => {
        img.src = ""; // cancel pending load
        el.textContent = "FAIL (timeout)";
        el.className = "pill fail";
      }, timeoutMs);
      img.onload  = () => { clearTimeout(t); el.textContent = "OK";   el.className = "pill ok";   };
      img.onerror = () => { clearTimeout(t); el.textContent = "FAIL"; el.className = "pill fail"; };
      // Cache-bust
      img.src = url + "?_=" + String(Date.now());
    }

    testImage("https://ipv6.ipv6.0ms.app/ping.png", "v6");
    testImage("https://ipv4.ipv6.0ms.app/ping.png", "v4");
  </script>


  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setCookieDomain", "*.ipv6.0ms.app"]);
    _paq.push(["setDomains", ["*.ipv6.0ms.app"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="https://ipv60msapp.matomo.cloud/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src='https://cdn.matomo.cloud/ipv60msapp.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <noscript>
    <p>
      <img referrerpolicy="no-referrer-when-downgrade"
           src="https://ipv60msapp.matomo.cloud/matomo.php?idsite=1&amp;rec=1"
           style="border:0;" alt="">
    </p>
  </noscript>
  <!-- End Matomo Code -->
</body>
</html>
